# Postman 集合使用指南

## 快速开始

### 1. 导入集合文件
1. 打开 Postman
2. 点击 "Import" 按钮
3. 选择 `contract_api_collection.json` 文件
4. 导入成功后，您将看到 "合同档案管理API - GLM-4.1V版本" 集合

### 2. 环境变量配置
集合已预配置以下环境变量：
- `base_url`: http://localhost:8000 （后端服务地址）
- `contract_id`: 自动设置（上传文件后自动获取）

### 3. 启动后端服务
在使用 Postman 测试前，请确保后端服务已启动：
```bash
cd e:\AICode\Trae_Test\contract_archive
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 接口测试流程

### 标准测试流程
1. **健康检查** - 验证服务是否正常运行
2. **上传合同文件** - 上传PDF/DOC文件，自动获取contract_id
3. **查询OCR状态** - 监控OCR处理进度
4. **获取合同列表** - 查看所有上传的合同
5. **获取合同详情** - 查看特定合同的详细信息
6. **手动触发OCR** - 如需重新处理OCR
7. **删除合同** - 清理测试数据（谨慎使用）

### QA问答测试流程
1. **提问并获取AI回答** - 向AI提问，自动获取session_id和message_id
2. **获取会话列表** - 查看所有问答会话
3. **获取会话历史** - 查看特定会话的完整对话记录
4. **提交用户反馈** - 对AI回答进行点赞/点踩/评论
5. **删除会话** - 清理测试数据（谨慎使用）

### 自动化功能
- **自动保存contract_id**: 上传文件后自动保存到环境变量
- **自动保存session_id和message_id**: 提问后自动保存到环境变量
- **OCR状态轮询**: 如果OCR还在处理中，会自动重试查询
- **环境变量自动清理**: 删除会话后自动清除相关环境变量
- **错误处理**: 自动记录错误信息到控制台

## 接口详情

### 1. 健康检查 `/health`
- **方法**: GET
- **用途**: 检查服务器状态、数据库连接、OCR服务状态
- **响应**: 返回系统健康状态

### 2. 上传合同文件 `/api/v1/contracts/upload`
- **方法**: POST
- **参数**: 
  - `file`: 合同文件（必需）
  - `title`: 合同标题（可选）
  - `description`: 合同描述（可选）
- **功能**: 上传文件并自动开始OCR处理

### 3. 获取合同列表 `/api/v1/contracts/`
- **方法**: GET
- **参数**: 
  - `skip`: 跳过记录数（默认0）
  - `limit`: 返回记录数（默认10）
- **功能**: 分页获取合同列表

### 4. 获取合同详情 `/api/v1/contracts/{contract_id}`
- **方法**: GET
- **功能**: 获取指定合同的详细信息

### 5. 查询OCR状态 `/api/v1/contracts/{contract_id}/ocr-status`
- **方法**: GET
- **功能**: 查询合同OCR处理状态
- **状态**: pending, processing, completed, failed

### 6. 手动触发OCR `/api/v1/contracts/{contract_id}/process-ocr`
- **方法**: POST
- **功能**: 手动触发OCR处理（使用GLM-4.1V模型）

### 7. 删除合同 `/api/v1/contracts/{contract_id}`
- **方法**: DELETE
- **功能**: 删除合同及相关文件
- **注意**: 此操作不可逆，请谨慎使用

## QA问答接口

### 8. 提问并获取AI回答 `/api/v1/qa/ask`
- **方法**: POST
- **参数**:
  - `question`: 用户问题（必需）
  - `session_id`: 会话ID（可选，新会话时为null）
  - `search_method`: 搜索方法（可选，默认"hybrid"）
- **功能**: 向AI提问并获取基于合同内容的智能回答
- **响应**: 返回session_id、message_id和AI回答
- **自动化**: 成功后自动保存session_id和message_id到环境变量

### 9. 获取会话列表 `/api/v1/qa/sessions`
- **方法**: GET
- **参数**:
  - `page`: 页码（默认1）
  - `size`: 每页数量（默认10）
- **功能**: 获取用户的问答会话列表
- **响应**: 返回分页的会话列表，包含会话标题和最后更新时间

### 10. 获取会话历史记录 `/api/v1/qa/sessions/{session_id}`
- **方法**: GET
- **功能**: 获取指定会话的完整历史记录
- **响应**: 返回会话中的所有问答消息
- **前置条件**: 需要先执行提问接口获取session_id

### 11. 提交用户反馈 `/api/v1/qa/sessions/{session_id}/messages/{message_id}/feedback`
- **方法**: POST
- **参数**:
  - `feedback_type`: 反馈类型（"like"、"dislike"或"neutral"）
  - `comment`: 反馈评论（可选）
- **功能**: 对AI回答提交用户反馈
- **前置条件**: 需要先执行提问接口获取session_id和message_id

### 12. 删除会话 `/api/v1/qa/sessions/{session_id}`
- **方法**: DELETE
- **功能**: 删除指定的问答会话及其所有消息记录
- **自动化**: 成功后自动清除环境变量中的session_id和message_id
- **注意**: 此操作不可逆，请谨慎使用

## GLM-4.1V 特性

本系统集成了 SiliconFlow 的 GLM-4.1V 视觉模型，具有以下优势：
- **高精度OCR**: 支持复杂文档的文字识别
- **多格式支持**: PDF、DOC、DOCX、图片格式
- **智能解析**: 自动识别文档结构和关键信息
- **快速处理**: 优化的处理流程，提高识别速度

## 测试建议

### 准备测试文件
建议准备以下类型的测试文件：
- 简单PDF文档（测试基本功能）
- 复杂合同文档（测试OCR精度）
- 扫描件图片（测试图像识别）
- 不同格式文件（测试兼容性）

### 测试步骤
1. 先运行健康检查确保服务正常
2. 上传一个简单的测试文件
3. 等待OCR处理完成（通过状态查询监控）
4. 查看处理结果和合同详情
5. 测试QA问答功能：
   - 提问获取AI回答
   - 查看会话列表和历史
   - 提交反馈测试
6. 测试其他功能接口

### 常见问题
- **上传失败**: 检查文件格式和大小限制
- **OCR处理失败**: 检查GLM-4.1V服务配置
- **接口404错误**: 确认URL路径正确（包含/api/v1前缀）
- **超时错误**: 大文件处理需要更长时间，请耐心等待
- **配置属性错误**: 如遇到 `'Settings' object has no attribute 'ALLOWED_EXTENSIONS'` 等错误，说明配置文件引用有误，已在最新版本中修复

## 版本更新记录

### v1.2 (2025-01-XX)
- ✅ 新增QA问答功能模块
- ✅ 添加5个QA相关API接口：提问、会话列表、会话历史、用户反馈、删除会话
- ✅ 集成Elasticsearch搜索服务，支持智能问答
- ✅ 自动化环境变量管理（session_id、message_id）
- ✅ 完善的测试脚本和错误处理机制

### v1.1 (2025-08-01)
- ✅ 修复了文件上传接口的配置引用错误
- ✅ 将 `ALLOWED_EXTENSIONS` 引用更正为 `supported_formats_list`
- ✅ 确保所有接口路径包含正确的 `/api/v1` 前缀
- ✅ 验证了所有接口的正常工作状态

## 监控和日志

### Postman 控制台
- 打开 Postman 控制台查看详细日志
- 自动记录请求响应时间
- 显示错误信息和调试信息

### 服务器日志
- 后端服务会输出详细的处理日志
- 包含OCR处理进度和错误信息
- 可用于问题诊断和性能分析

## 技术支持

如遇到问题，请检查：
1. 后端服务是否正常启动
2. 环境变量配置是否正确
3. 文件格式是否支持
4. 网络连接是否正常

更多技术细节请参考其他API文档文件。