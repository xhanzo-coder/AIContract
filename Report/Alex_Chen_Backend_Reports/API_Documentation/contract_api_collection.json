{
  "info": {
    "name": "合同档案管理API - GLM-4.1V版本",
    "description": "基于SiliconFlow GLM-4.1V视觉模型的合同档案管理系统API测试集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "contract_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. 健康检查",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has status field\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('status');",
              "    pm.expect(jsonData.status).to.eql('healthy');",
              "});",
              "",
              "pm.test(\"Response time is less than 1000ms\", function () {",
              "    pm.expect(pm.response.responseTime).to.be.below(1000);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/health",
          "host": ["{{base_url}}"],
          "path": ["health"]
        },
        "description": "检查服务器运行状态"
      }
    },
    {
      "name": "2. 上传合同文件",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Upload successful\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('contract_id');",
              "    pm.expect(jsonData).to.have.property('message');",
              "    ",
              "    // 保存contract_id到环境变量",
              "    pm.collectionVariables.set(\"contract_id\", jsonData.contract_id);",
              "    console.log(\"Contract ID saved: \" + jsonData.contract_id);",
              "});",
              "",
              "pm.test(\"OCR processing started\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.ocr_status).to.be.oneOf(['processing', 'pending']);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "formdata",
          "formdata": [
            {
              "key": "file",
              "type": "file",
              "src": [],
              "description": "选择要上传的PDF文件"
            },
            {
              "key": "title",
              "value": "测试合同文档",
              "type": "text",
              "description": "合同标题"
            },
            {
              "key": "description",
              "value": "这是一个用于测试GLM-4.1V OCR功能的合同文档",
              "type": "text",
              "description": "合同描述"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/upload",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", "upload"]
        },
        "description": "上传合同文件并自动触发OCR处理"
      }
    },
    {
      "name": "3. 获取合同列表",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has contracts array\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('contracts');",
              "    pm.expect(jsonData.contracts).to.be.an('array');",
              "});",
              "",
              "pm.test(\"Response has pagination info\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('total');",
              "    pm.expect(jsonData).to.have.property('skip');",
              "    pm.expect(jsonData).to.have.property('limit');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/?skip=0&limit=10",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", ""],
          "query": [
            {
              "key": "skip",
              "value": "0",
              "description": "跳过的记录数"
            },
            {
              "key": "limit",
              "value": "10",
              "description": "返回的记录数限制"
            }
          ]
        },
        "description": "分页获取所有合同列表"
      }
    },
    {
      "name": "4. 获取合同详情",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has contract details\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('id');",
              "    pm.expect(jsonData).to.have.property('title');",
              "    pm.expect(jsonData).to.have.property('filename');",
              "    pm.expect(jsonData).to.have.property('ocr_status');",
              "});",
              "",
              "pm.test(\"Contract ID matches\", function () {",
              "    var jsonData = pm.response.json();",
              "    var expectedId = parseInt(pm.collectionVariables.get(\"contract_id\"));",
              "    pm.expect(jsonData.id).to.eql(expectedId);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/{{contract_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", "{{contract_id}}"]
        },
        "description": "获取指定合同的详细信息"
      }
    },
    {
      "name": "5. 查询OCR状态",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has OCR status\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('contract_id');",
              "    pm.expect(jsonData).to.have.property('ocr_status');",
              "    pm.expect(jsonData.ocr_status).to.be.oneOf(['pending', 'processing', 'completed', 'failed']);",
              "});",
              "",
              "// 如果还在处理中，5秒后自动重新查询",
              "pm.test(\"Auto retry if processing\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.ocr_status === 'processing') {",
              "        console.log(\"OCR still processing, will retry in 5 seconds...\");",
              "        setTimeout(function(){",
              "            postman.setNextRequest(\"5. 查询OCR状态\");",
              "        }, 5000);",
              "    }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/{{contract_id}}/ocr-status",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", "{{contract_id}}", "ocr-status"]
        },
        "description": "查询合同OCR处理状态"
      }
    },
    {
      "name": "6. 手动触发OCR处理 (GLM-4.1V)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"OCR processing started\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('message');",
              "    pm.expect(jsonData).to.have.property('contract_id');",
              "    pm.expect(jsonData).to.have.property('status');",
              "    pm.expect(jsonData.status).to.eql('processing');",
              "});",
              "",
              "pm.test(\"GLM-4.1V model specified\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.model) {",
              "        pm.expect(jsonData.model).to.include('GLM-4.1V');",
              "    }",
              "});",
              "",
              "// 自动等待5秒后查询状态",
              "setTimeout(function(){",
              "    postman.setNextRequest(\"5. 查询OCR状态\");",
              "}, 5000);"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/{{contract_id}}/process-ocr",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", "{{contract_id}}", "process-ocr"]
        },
        "description": "手动触发合同OCR处理（使用GLM-4.1V模型）"
      }
    },
    {
      "name": "7. 删除合同 (谨慎使用)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Contract deleted successfully\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('message');",
              "    pm.expect(jsonData).to.have.property('contract_id');",
              "    pm.expect(jsonData.message).to.include('删除成功');",
              "});",
              "",
              "pm.test(\"Files deleted\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.deleted_files) {",
              "        pm.expect(jsonData.deleted_files).to.be.an('array');",
              "    }",
              "});",
              "",
              "// 清除环境变量中的contract_id",
              "pm.collectionVariables.unset(\"contract_id\");",
              "console.log(\"Contract ID cleared from variables\");"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/v1/contracts/{{contract_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "v1", "contracts", "{{contract_id}}"]
        },
        "description": "删除指定合同及相关文件（谨慎使用）"
      }
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局前置脚本",
          "console.log('Request to: ' + pm.request.url);",
          "console.log('Method: ' + pm.request.method);",
          "",
          "// 检查contract_id是否存在（除了健康检查和上传接口）",
          "var requestName = pm.info.requestName;",
          "var needsContractId = ['4. 获取合同详情', '5. 查询OCR状态', '6. 手动触发OCR处理 (GLM-4.1V)', '7. 删除合同 (谨慎使用)'];",
          "",
          "if (needsContractId.includes(requestName)) {",
          "    var contractId = pm.collectionVariables.get('contract_id');",
          "    if (!contractId) {",
          "        console.warn('Warning: contract_id not set. Please run upload request first.');",
          "    }",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局后置脚本",
          "console.log('Response status: ' + pm.response.status);",
          "console.log('Response time: ' + pm.response.responseTime + 'ms');",
          "",
          "// 记录错误信息",
          "if (pm.response.code >= 400) {",
          "    console.error('Error response: ' + pm.response.text());",
          "}"
        ]
      }
    }
  ]
}